<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title>Auður Ólafsdóttir 60 ára</title>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Style-Type" content="text/css">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="anime.min.js"></script>
	<link rel="stylesheet" href="main.css">
	<script src="overlayjs-master/overlay.js"></script>
	<link rel="stylesheet" href="overlayjs-master/overlay.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">

</head>
<body>

<div class="container">

	<div id="artworkDisplay" class="box" >
		</div>
   
	<div id="userHover" class="box stack-top" >
		<svg id="main_svg"  version="1.0" xmlns="http://www.w3.org/2000/svg">
		</svg>
	</div>

</div>

</body>
<script defer="defer">

$.ajaxSetup ({
    // Disable caching of AJAX responses
    //cache: false
});


function setSvgViewbox(jsonObject) {
	
	var svg_drawing = $('#main_svg')
	var _height = jsonObject[0].Height
	var _width = jsonObject[0].Width
	
	svg_drawing.height(_height);
	svg_drawing.width(_width);
	svg_drawing.removeAttr('viewBox');
	svg_drawing.each(function () { $(this)[0].setAttribute('viewBox', '0 0 '+_width+' '+_height) });
}

function generateOverlayShape(jsonObject) {
	
	var svg_drawing = $('#main_svg')
	
	jsonObject.forEach(obj => {
	  svg_drawing.append($(polylinePaths(obj)))
	});
}

// https://github.com/m-thalmann/overlayjs
function doThing(g)
{
	$.getJSON( "FinalData/Final_UserInfo/"+g.id+".json", function( user_object ) {
		var overlay = new Overlay();
		var user_name = user_object.Name
		var memory = user_object.Memory;
		//Final_Images_Nobg
		$('.overlay_content').load('modal.html', function() {
			$('.overlay_content').css('border',"8px solid "+user_object.HexColor)
			$("#modal_user_name").text(user_name)
			$("#modal_memory").html(memory)
			$("#modal_user").attr("src","FinalData/Final_Images_Clipped/"+g.id+".png"); 
		});
	});
}

function doHover(g, adder)
{
	var image = $("#img_"+g.id)
	var top = image.attr("data-top")
	anime({
		targets: "#img_"+g.id,
		top: parseInt(top) - adder,
	});
	//image.css('top', parseInt(top) - adder +"px")
}


function polylinePaths(obj) {
    g=$(document.createElementNS('http://www.w3.org/2000/svg', 'g')).attr({id: obj.ImageId})
		$(g).append(
			$(document.createElementNS('http://www.w3.org/2000/svg', 'polyline'))
			.attr({
				class: "main",
				points: obj.SvgPolyline
			})
		)
    return $(g)[0]
}

var images = []

$.getJSON( "FinalData/artwork.json", function( json ) {

	// start by creating overlay
	setSvgViewbox(json);
	generateOverlayShape(json);
	
	// Append every image
	var zIndex = 0;
	json.forEach(obj => {
		zIndex++;
		var image = loadAndPlaceImage(obj, zIndex);
		images.push(image)
		$('#artworkDisplay').append($(image))
	});
	
	document.querySelectorAll("g").forEach(function(userItem) {
	  userItem.addEventListener("click", () => doThing(userItem));
	  userItem.addEventListener("mouseover", () => doHover(userItem, 5));
	  userItem.addEventListener("mouseout", () => doHover(userItem, 0));
	});
	
	// Add some breath to it
	anime({
	  targets: ['.move', 'svg'],
	  translateY: 3,
	  direction: 'alternate',
	  loop: true,
	  easing: 'easeInOutSine'
	});
 });
 
 //margin left
function loadAndPlaceImage(image, zIndex)
{
	var left = $("#main_svg").offset().left-20;
	var top = $("#main_svg").offset().top;
	var imageDom = new Image();
	
	imageDom.dataset.left = image.Left
	imageDom.dataset.top = image.Top
	imageDom.id = "img_"+ image.ImageId
	imageDom.className  = "move";
	imageDom.src = image.PreprocessedPath;
	imageDom.style.left = left+image.Left+"px";
	imageDom.style.top = image.Top+"px";
	imageDom.style.zIndex = zIndex;
	return imageDom;
}

function replaceOffset(image, left, top)
{
	image.style.left = parseInt(image.dataset.left) + left+"px";
	// TODO: Handle top same way?
	image.style.top = image.Top+"px";
}

$( window ).resize(function() {
	var left = $("#main_svg").offset().left-20;
	var top = $("#main_svg").offset().top; // +30 ?
	images.forEach(function(image) {
		replaceOffset(image, left, top);
	})
});

</script>
</html>
